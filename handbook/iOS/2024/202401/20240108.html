<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>NSTimer Block ä¸ºä»€ä¹ˆä¸ä¼šè§¦å‘å¾ªç¯å¼•ç”¨ï¼Ÿï¼ | å¼ èŒ¨ä¸€é£</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/my-blog/avatar.png">
    <meta name="description" content="è€å¤«èŠå‘å°‘å¹´ç‹‚,å·¦ç‰µé»„,å³æ“è‹,é”¦å¸½è²‚è£˜,åƒéª‘å·å¹³å†ˆã€‚ä¸ºæŠ¥å€¾åŸéšå¤ªå®ˆ,äº²å°„è™,çœ‹å­™éƒã€‚ é…’é…£èƒ¸èƒ†å°šå¼€å¼ ã€‚é¬“å¾®éœœ,åˆä½•å¦¨!æŒèŠ‚äº‘ä¸­,ä½•æ—¥é£å†¯å”?ä¼šæŒ½é›•å¼“å¦‚æ»¡æœˆ,è¥¿åŒ—æœ›,å°„å¤©ç‹¼ã€‚">
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.2175243c.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.83219bff.js" as="script"><link rel="preload" href="/my-blog/assets/js/3.e68ab5ce.js" as="script"><link rel="preload" href="/my-blog/assets/js/1.768e4641.js" as="script"><link rel="preload" href="/my-blog/assets/js/22.9bbde15a.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.c206caee.js"><link rel="prefetch" href="/my-blog/assets/js/11.9f4ed03b.js"><link rel="prefetch" href="/my-blog/assets/js/12.9c1daaff.js"><link rel="prefetch" href="/my-blog/assets/js/13.508ca0aa.js"><link rel="prefetch" href="/my-blog/assets/js/14.f2709fef.js"><link rel="prefetch" href="/my-blog/assets/js/15.fe2625e7.js"><link rel="prefetch" href="/my-blog/assets/js/16.14234636.js"><link rel="prefetch" href="/my-blog/assets/js/17.dac017be.js"><link rel="prefetch" href="/my-blog/assets/js/18.412e2895.js"><link rel="prefetch" href="/my-blog/assets/js/19.2fdd618b.js"><link rel="prefetch" href="/my-blog/assets/js/20.c12b7107.js"><link rel="prefetch" href="/my-blog/assets/js/21.9f012cff.js"><link rel="prefetch" href="/my-blog/assets/js/23.fae03859.js"><link rel="prefetch" href="/my-blog/assets/js/24.9c2773c9.js"><link rel="prefetch" href="/my-blog/assets/js/25.d72b23bf.js"><link rel="prefetch" href="/my-blog/assets/js/26.02e61b2e.js"><link rel="prefetch" href="/my-blog/assets/js/27.85eafcc1.js"><link rel="prefetch" href="/my-blog/assets/js/28.364da631.js"><link rel="prefetch" href="/my-blog/assets/js/29.b0ad14d8.js"><link rel="prefetch" href="/my-blog/assets/js/30.333ca256.js"><link rel="prefetch" href="/my-blog/assets/js/31.206c8a40.js"><link rel="prefetch" href="/my-blog/assets/js/32.7fb99002.js"><link rel="prefetch" href="/my-blog/assets/js/33.069f064a.js"><link rel="prefetch" href="/my-blog/assets/js/34.5e3b35db.js"><link rel="prefetch" href="/my-blog/assets/js/35.0bd3d6ff.js"><link rel="prefetch" href="/my-blog/assets/js/36.fda2e78e.js"><link rel="prefetch" href="/my-blog/assets/js/37.6f1fb53e.js"><link rel="prefetch" href="/my-blog/assets/js/4.b2fd2bed.js"><link rel="prefetch" href="/my-blog/assets/js/5.9d45f87e.js"><link rel="prefetch" href="/my-blog/assets/js/6.76b9de72.js"><link rel="prefetch" href="/my-blog/assets/js/7.0366ddcd.js"><link rel="prefetch" href="/my-blog/assets/js/8.df7f4290.js"><link rel="prefetch" href="/my-blog/assets/js/9.a3521382.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.2175243c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>å¼ èŒ¨ä¸€é£</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>è€å¤«èŠå‘å°‘å¹´ç‹‚,å·¦ç‰µé»„,å³æ“è‹,é”¦å¸½è²‚è£˜,åƒéª‘å·å¹³å†ˆã€‚ä¸ºæŠ¥å€¾åŸéšå¤ªå®ˆ,äº²å°„è™,çœ‹å­™éƒã€‚ é…’é…£èƒ¸èƒ†å°šå¼€å¼ ã€‚é¬“å¾®éœœ,åˆä½•å¦¨!æŒèŠ‚äº‘ä¸­,ä½•æ—¥é£å†¯å”?ä¼šæŒ½é›•å¼“å¦‚æ»¡æœˆ,è¥¿åŒ—æœ›,å°„å¤©ç‹¼ã€‚</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>å¼ èŒ¨ä¸€é£</span>
          Â Â 
          <span data-v-25ba6db2>2015 - </span>
          2024
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><img src="/my-blog/avatar.png" alt="å¼ èŒ¨ä¸€é£" class="logo"> <span class="site-name">å¼ èŒ¨ä¸€é£</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  é¦–é¡µ
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      ç›®å½•
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/categories/iOSå¼€å‘/" class="nav-link"><i class="undefined"></i>
  iOSå¼€å‘
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/ç”Ÿæ´»/" class="nav-link"><i class="undefined"></i>
  ç”Ÿæ´»
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/é¢è¯•é¢˜/" class="nav-link"><i class="undefined"></i>
  é¢è¯•é¢˜
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  æ ‡ç­¾
</a></div><div class="nav-item"><a href="/my-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  æ—¶é—´çº¿
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      ç®€å†
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/views/Resume/resume.html" class="nav-link"><i class="undefined"></i>
  æˆ‘çš„ç®€å†
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      å‹æƒ…é“¾æ¥
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><img src="avatar.png" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    å¼ èŒ¨ä¸€é£
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>27</h3> <h6 data-v-39576ba9>æ–‡ç« </h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>9</h3> <h6 data-v-39576ba9>æ ‡ç­¾</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  é¦–é¡µ
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      ç›®å½•
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/categories/iOSå¼€å‘/" class="nav-link"><i class="undefined"></i>
  iOSå¼€å‘
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/ç”Ÿæ´»/" class="nav-link"><i class="undefined"></i>
  ç”Ÿæ´»
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/é¢è¯•é¢˜/" class="nav-link"><i class="undefined"></i>
  é¢è¯•é¢˜
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  æ ‡ç­¾
</a></div><div class="nav-item"><a href="/my-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  æ—¶é—´çº¿
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      ç®€å†
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/views/Resume/resume.html" class="nav-link"><i class="undefined"></i>
  æˆ‘çš„ç®€å†
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      å‹æƒ…é“¾æ¥
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>NSTimer Block ä¸ºä»€ä¹ˆä¸ä¼šè§¦å‘å¾ªç¯å¼•ç”¨ï¼Ÿï¼</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>å¼ èŒ¨ä¸€é£</span>
          Â Â 
          <span data-v-25ba6db2>2015 - </span>
          2024
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">NSTimer Block ä¸ºä»€ä¹ˆä¸ä¼šè§¦å‘å¾ªç¯å¼•ç”¨ï¼Ÿï¼</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>å¼ èŒ¨ä¸€é£</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>2024/1/8</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>iOSå¼€å‘</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="å¼•å­"><a href="#å¼•å­" class="header-anchor">#</a> å¼•å­</h1> <p>NSTimer æ˜¯ iOS Foundation æ¡†æ¶ä¸­ä¸€ç§è®¡æ—¶å™¨ï¼Œåœ¨ç»è¿‡ä¸€å®šçš„æ—¶é—´é—´éš”åè§¦å‘ï¼Œå‘ç›®æ ‡å¯¹è±¡å‘é€æŒ‡å®šçš„æ¶ˆæ¯ã€‚</p> <p>æœ¬æ–‡ä»¥æ ‡é¢˜ä¸ºä¸»çº¿ï¼Œæ¢ç©¶ NSTimer ä¸ Runloop ä¹‹é—´çš„å…³ç³»ã€‚</p> <p>æˆ‘ä»¬å…ˆçœ‹ä¸‹é¢è¿™æ®µä»£ç çš„è¿è¡Œï¼š</p> <img src="/my-blog/assets/img/20240108.165c89ab.jpg" width="100%"> <p>åœºæ™¯ï¼š</p> <p>ViewController --Present-&gt; SecondViewControllerã€‚å…¶ä¸­ Manager å®ä¾‹ä¼šæŒæœ‰ Blockã€‚
SecondViewController ä¸­æœ‰ä¸¤ä¸ªç‚¹å‡»æŒ‰é’®ï¼Œtest1 æŒ‰é’®å’Œ test2 æŒ‰é’®
åˆ†åˆ«è°ƒåº¦æ–¹æ³• -didTapTest1: ä¸ -didTapTest2:</p> <p>æµç¨‹ï¼š</p> <ol><li>ç‚¹å‡» xx æŒ‰é’®ï¼›</li> <li>ç­‰å¾…æ•°ç§’ï¼Œæ‰“å° block ä¸­çš„å†…å®¹ï¼›</li> <li>å…³é—­ SecondViewController æ§åˆ¶å™¨ï¼›</li></ol> <p>ç‚¹å‡» test1 æŒ‰é’®æ‰§è¡Œæµç¨‹ï¼Œæ‰“å°ï¼š</p> <div class="language- extra-class"><pre><code>2023-01-25 16:59:08.712191+0800 BlockMemoryLeaks[27573:1465591] Manager: &lt;Manager: 0x6000002e40c0&gt;
</code></pre></div><p>ç‚¹å‡» test2 æŒ‰é’®æ‰§è¡Œæµç¨‹ï¼Œæ‰“å°ï¼š</p> <div class="language- extra-class"><pre><code>2023-01-25 17:01:47.305332+0800 BlockMemoryLeaks[27622:1467958] Timer: &lt;__NSCFTimer: 0x6000000400c0&gt;
2023-01-25 17:01:48.305246+0800 BlockMemoryLeaks[27622:1467958] Timer: &lt;__NSCFTimer: 0x6000000400c0&gt;
2023-01-25 17:01:49.141697+0800 BlockMemoryLeaks[27622:1467958] SecondViewController dealloc
</code></pre></div><p>test1 Manager å’Œé¢„æœŸä¸€æ ·ï¼ŒManager -&gt; Blockï¼ŒBlock -&gt; selfï¼Œself -&gt; Managerï¼Œé€ æˆäº†å¾ªç¯å¼•ç”¨ã€‚</p> <p>è€Œ test2 NSTimer è™½ç„¶è¢« self æŒæœ‰ï¼Œè¿™ä¸ª Block ä¹Ÿæ•è·äº† selfï¼Œä½†è¿™å¹¶æ²¡æœ‰è§¦å‘å¾ªç¯å¼•ç”¨ã€‚</p> <h2 id="nstimer-ä¸-runloop"><a href="#nstimer-ä¸-runloop" class="header-anchor">#</a> NSTimer ä¸ Runloop</h2> <p>åœ¨è‹¹æœå…³äº NSTimer æ–‡æ¡£ä¸­æœ‰æè¿°ï¼ŒNSTimer å’Œ CFRunLoopTimerRef æ˜¯ toll-free bridged çš„ï¼š</p> <div class="language- extra-class"><pre><code>NSTimer is toll-free bridged with its Core Foundation counterpart, CFRunLoopTimerRef.
</code></pre></div><p>NSTimer æ˜¯ä¸­é—´æ¡¥æ¥å±‚ï¼Œæ„å‘³ç€å…¶å®å®šæ—¶å™¨è¿ä½œæ˜¯äº¤ç»™ Runloop å¤„ç†çš„ã€‚</p> <div class="language- extra-class"><pre><code>typedef struct CF_BRIDGED_MUTABLE_TYPE(NSTimer) __CFRunLoopTimer * CFRunLoopTimerRef;
</code></pre></div><p>å³ä¾¿æ˜¯ NSTimer æ˜¯ä¸­é—´å±‚ï¼Œå¦‚æœåº•å±‚ Timer æŒæœ‰äº† Blockï¼Œè¿˜æ˜¯å­˜åœ¨å¾ªç¯å¼•ç”¨ã€‚æ¥ç€é˜…è¯» Runloop ä»£ç æ¥æ‰¾åˆ°æ ‡é¢˜é—®é¢˜çš„ç­”æ¡ˆã€‚</p> <h3 id="runloop-çš„-mode"><a href="#runloop-çš„-mode" class="header-anchor">#</a> RunLoop çš„ Mode</h3> <p>CFRunloop ä¸ CFRunloop Mode çš„å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š</p> <div class="language- extra-class"><pre><code>struct __CFRunLoopMode {
    CFStringRef _name;            
    CFMutableSetRef _sources0;    
    CFMutableSetRef _sources1;    
    CFMutableArrayRef _observers;
    CFMutableArrayRef _timers;    
    // ...
};

struct __CFRunLoop {
    CFRuntimeBase _base;
    CFMutableSetRef _commonModes;   
    CFMutableSetRef _commonModeItems;
    CFRunLoopModeRef _currentMode;  
    CFMutableSetRef _modes;         
    // ...
};
</code></pre></div><p>ä¸€ä¸ª CFRunLoop ä¸­åŒ…å«è‹¥å¹²ä¸ª CFRunLoopModeï¼ŒCFRunLoopTimer åˆ™è¢«æ³¨å†Œåœ¨ mode ä¸‹ã€‚</p> <div class="language- extra-class"><pre><code>struct __CFRunLoopTimer {
    CFRuntimeBase _base;
    uint16_t _bits;
    pthread_mutex_t _lock;
    CFRunLoopRef _runLoop;
    CFMutableSetRef _rlModes;
    CFAbsoluteTime _nextFireDate;
    CFTimeInterval _interval;		/* immutable */
    CFTimeInterval _tolerance;          /* mutable */
    uint64_t _fireTSR;			/* TSR units */
    CFIndex _order;			/* immutable */
    CFRunLoopTimerCallBack _callout;	/* immutable */
    CFRunLoopTimerContext _context;	/* immutable, except invalidation */
};
</code></pre></div><p>CFRunLoopTimer åŒ…å«ä¸€ä¸ªæ—¶é—´é•¿åº¦å’Œä¸€ä¸ªå›è°ƒï¼Œæ ‡è®°äº†å®ƒæ‰€åœ¨çš„ runloop modeã€‚</p> <h3 id="ä»æ·»åŠ -timer-å¼€å§‹"><a href="#ä»æ·»åŠ -timer-å¼€å§‹" class="header-anchor">#</a> ä»æ·»åŠ  Timer å¼€å§‹</h3> <p>å…ˆçœ‹ CFRunLoopAddTimer æ–¹æ³•</p> <div class="language- extra-class"><pre><code>void CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef rlt, CFStringRef modeName) {    
    CHECK_FOR_FORK();
    if (__CFRunLoopIsDeallocating(rl)) return;
    if (!__CFIsValid(rlt) || (NULL != rlt-&gt;_runLoop &amp;&amp; rlt-&gt;_runLoop != rl)) return;
    __CFRunLoopLock(rl);
    if (modeName == kCFRunLoopCommonModes) {
        /* Mode æ˜¯ CommonModes */
        CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;
        if (NULL == rl-&gt;_commonModeItems) {
            rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);
        }
        CFSetAddValue(rl-&gt;_commonModeItems, rlt);
        if (NULL != set) {
            CFTypeRef context[2] = {rl, rlt};
            /* å°† Timer åŠ å…¥åˆ°æ‰€æœ‰ Common Mode ä¸­ */
            CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);
            CFRelease(set);
        }
    } else {
        /* Mode æ˜¯æŒ‡å®š Mode */
        CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, true);
        if (NULL != rlm) {
            if (NULL == rlm-&gt;_timers) {
                CFArrayCallBacks cb = kCFTypeArrayCallBacks;
                cb.equal = NULL;
                rlm-&gt;_timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;cb);
            }
        }
        if (NULL != rlm &amp;&amp; !CFSetContainsValue(rlt-&gt;_rlModes, rlm-&gt;_name)) {
            __CFRunLoopTimerLock(rlt);
            if (NULL == rlt-&gt;_runLoop) {
                // æ ‡è®° Timer å¯¹åº”çš„ Runloop
                rlt-&gt;_runLoop = rl;
            } else if (rl != rlt-&gt;_runLoop) {
                __CFRunLoopTimerUnlock(rlt);
                __CFRunLoopModeUnlock(rlm);
                __CFRunLoopUnlock(rl);
                return;
            }
            // æ ‡è®° Timer å¯¹åº”çš„ Runloop Mode
            CFSetAddValue(rlt-&gt;_rlModes, rlm-&gt;_name);
            __CFRunLoopTimerUnlock(rlt);
            __CFRunLoopTimerFireTSRLock();
            /* é‡æ–°æ’åºæŒ‡å®š Mode ä¸­çš„å„ä¸ª Timer */
            __CFRepositionTimerInMode(rlm, rlt, false);
            __CFRunLoopTimerFireTSRUnlock();
            if (!_CFExecutableLinkedOnOrAfter(CFSystemVersionLion)) {
                if (rl != CFRunLoopGetCurrent()) CFRunLoopWakeUp(rl);
            }
        }
        if (NULL != rlm) {
            __CFRunLoopModeUnlock(rlm);
        }
    }
    __CFRunLoopUnlock(rl);
}
</code></pre></div><p>CFRunLoopAddTimer(<em>:</em>:<em>ğŸ˜ƒ å°† Timer æ·»åŠ åˆ° Runloop çš„æŒ‡å®š Mode ä¸‹ã€‚å¦‚æœè¢«æ·»åŠ çš„æ˜¯ commonModes åˆ™éå†æ‰€æœ‰ commonMode è°ƒç”¨ CFRunLoopAddTimer(</em>:<em>:</em>ğŸ˜ƒ æ–¹æ³•ã€‚ç„¶åè°ƒç”¨ __CFRepositionTimerInMode å‡½æ•°æ’åºï¼š</p> <div class="language- extra-class"><pre><code>static void __CFRepositionTimerInMode(CFRunLoopModeRef rlm, CFRunLoopTimerRef rlt, Boolean isInArray) {
    if (!rlt) return;
    // æ‹¿åˆ° Mode ä¸‹æ‰€æœ‰ timer
    CFMutableArrayRef timerArray = rlm-&gt;_timers;
    if (!timerArray) return;
    Boolean found = false;
    if (isInArray) {
        CFIndex idx = CFArrayGetFirstIndexOfValue(timerArray, CFRangeMake(0, CFArrayGetCount(timerArray)), rlt);
        if (kCFNotFound != idx) {
            CFRetain(rlt);
            CFArrayRemoveValueAtIndex(timerArray, idx);
            found = true;
        }
    }
    if (!found &amp;&amp; isInArray) return;
    // äºŒåˆ†æ³•ç¡®å®šä½ç½®ï¼Œæ’å…¥æœ‰åºæ•°ç»„
    CFIndex newIdx = __CFRunLoopInsertionIndexInTimerArray(timerArray, rlt);
    CFArrayInsertValueAtIndex(timerArray, newIdx, rlt);
    // 
    __CFArmNextTimerInMode(rlm, rlt-&gt;_runLoop);
    if (isInArray) CFRelease(rlt);
}
</code></pre></div><p>__CFRepositionTimerInMode æ–¹æ³•ä»¥è§¦å‘æ—¶é—´ _fireTSR ä»å°åˆ°å¤§æ’åº rlm-&gt;timers Mode çš„ timers æ•°ç»„ã€‚
æ’åºå®Œæˆåè°ƒç”¨ __CFArmNextTimerInMode é‡æ–°æ³¨å†Œæœ€æ—©åº”è¯¥è¢«è§¦å‘çš„ timer</p> <div class="language- extra-class"><pre><code>static void __CFArmNextTimerInMode(CFRunLoopModeRef rlm, CFRunLoopRef rl) {    
    uint64_t nextHardDeadline = UINT64_MAX;
    uint64_t nextSoftDeadline = UINT64_MAX;
    if (rlm-&gt;_timers) {
        // ä¿®æ­£ tolerance å€¼ï¼Œç¡®ä¿æ—¶é—´æœ€è¿‘çš„ timer + tolerance å¤§äºå…¶ä»– Timer æ—¶ï¼Œä¸å½±å“å…¶ä»– Timer è§¦å‘
        for (CFIndex idx = 0, cnt = CFArrayGetCount(rlm-&gt;_timers); idx &lt; cnt; idx++) {
            CFRunLoopTimerRef t = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(rlm-&gt;_timers , idx);
            if (__CFRunLoopTimerIsFiring(t)) continue;
            int32_t err = CHECKINT_NO_ERROR;
            uint64_t oneTimerSoftDeadline = t-&gt;_fireTSR;
            uint64_t oneTimerHardDeadline = check_uint64_add(t-&gt;_fireTSR, __CFTimeIntervalToTSR(t-&gt;_tolerance), &amp;err);
            if (err != CHECKINT_NO_ERROR) oneTimerHardDeadline = UINT64_MAX;    

            if (oneTimerSoftDeadline &gt; nextHardDeadline) {
                break;
            }
            if (oneTimerSoftDeadline &lt; nextSoftDeadline) {
                nextSoftDeadline = oneTimerSoftDeadline;
            }
            if (oneTimerHardDeadline &lt; nextHardDeadline) {
                nextHardDeadline = oneTimerHardDeadline;
            }
        }
        if (nextSoftDeadline &lt; UINT64_MAX &amp;&amp; (nextHardDeadline != rlm-&gt;_timerHardDeadline || nextSoftDeadline != rlm-&gt;_timerSoftDeadline)) {
            if (CFRUNLOOP_NEXT_TIMER_ARMED_ENABLED()) {
                CFRUNLOOP_NEXT_TIMER_ARMED((unsigned long)(nextSoftDeadline - mach_absolute_time()));
            }
#if USE_DISPATCH_SOURCE_FOR_TIMERS
            uint64_t leeway = __CFTSRToNanoseconds(nextHardDeadline - nextSoftDeadline);
            dispatch_time_t deadline = __CFTSRToDispatchTime(nextSoftDeadline);
#if USE_MK_TIMER_TOO
            if (leeway &gt; 0) {
                // æœ‰ tolerance é‡‡ç”¨ _dispatch_source_set_runloop_timer_4CF æ–¹å¼æ³¨å†Œå®šæ—¶å™¨
                if (rlm-&gt;_mkTimerArmed &amp;&amp; rlm-&gt;_timerPort) {
                    AbsoluteTime dummy;
                    mk_timer_cancel(rlm-&gt;_timerPort, &amp;dummy);
                    rlm-&gt;_mkTimerArmed = false;
                }
                _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, deadline, DISPATCH_TIME_FOREVER, leeway);
                rlm-&gt;_dispatchTimerArmed = true;
            } else {
                // æ²¡æœ‰ tolerance é‡‡ç”¨ RunloopMode çš„ mk_timer æ–¹å¼æ³¨å†Œ mach-port äº‹ä»¶
                if (rlm-&gt;_dispatchTimerArmed) {
                    _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 888);
                    rlm-&gt;_dispatchTimerArmed = false;
                }
                if (rlm-&gt;_timerPort) {
                    mk_timer_arm(rlm-&gt;_timerPort, __CFUInt64ToAbsoluteTime(nextSoftDeadline));
                    rlm-&gt;_mkTimerArmed = true;
                }
            }
#else
            _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, deadline, DISPATCH_TIME_FOREVER, leeway);
#endif
#else
            if (rlm-&gt;_timerPort) {
                mk_timer_arm(rlm-&gt;_timerPort, __CFUInt64ToAbsoluteTime(nextSoftDeadline));
            }
#endif
        } else if (nextSoftDeadline == UINT64_MAX) {
            // å¦‚æœæ²¡æœ‰å®šæ—¶å™¨å®‰æ’ï¼Œåˆ™è§£é™¤å®šæ—¶å™¨ï¼Œå°† _mkTimerArmed å€¼ç½®ä¸º false
            if (rlm-&gt;_mkTimerArmed &amp;&amp; rlm-&gt;_timerPort) {
                AbsoluteTime dummy;
                mk_timer_cancel(rlm-&gt;_timerPort, &amp;dummy);
                rlm-&gt;_mkTimerArmed = false;
            }
#if USE_DISPATCH_SOURCE_FOR_TIMERS
            if (rlm-&gt;_dispatchTimerArmed) {
                _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 333);
                rlm-&gt;_dispatchTimerArmed = false;
            }
#endif
        }
    }
    // è®¾ç½® Runloop Mode çš„ä¸¤ä¸ªæˆªæ­¢æ—¶é—´å­—æ®µ Deadline
    rlm-&gt;_timerHardDeadline = nextHardDeadline;
    rlm-&gt;_timerSoftDeadline = nextSoftDeadline;
}
</code></pre></div><p>è¿™ä¸ªæ–¹æ³•ç®€å•æ¥è¯´å°±æ˜¯æ³¨å†Œä¸‹ä¸€ä¸ªéœ€è¦è§¦å‘çš„ Timer äº‹ä»¶åˆ° Runloop ä¸­ã€‚å…¶ä¸­æœ‰é…ç½® tolerance çš„ Timer ä¼šè¢«æ³¨å†Œä¸ºä¸€ä¸ª GCD Timerï¼Œæœªé…ç½® tolerance çš„ Timer æˆªæ­¢æ—¶é—´ä¼šè¢«æ³¨å†Œä¸€ä¸ª mach-port äº‹ä»¶ï¼Œè®¾ç½®åˆ° Runloop Mode ä¸­ã€‚</p> <h3 id="è§¦å‘-timercallback"><a href="#è§¦å‘-timercallback" class="header-anchor">#</a> è§¦å‘ TimerCallBack</h3> <p>ç­‰åˆ° Runloop è¢« timer mach-port å”¤é†’æ—¶ï¼Œè°ƒç”¨ __CFRunLoopDoTimers å‡½æ•°ï¼Œç­›é€‰ _fireTSR æ—©äºå½“å‰æ—¶åˆ»çš„ timersï¼š</p> <div class="language- extra-class"><pre><code>static Boolean __CFRunLoopDoTimers(CFRunLoopRef rl, CFRunLoopModeRef rlm, uint64_t limitTSR) {	/* DOES CALLOUT */
    Boolean timerHandled = false;
    CFMutableArrayRef timers = NULL;
    for (CFIndex idx = 0, cnt = rlm-&gt;_timers ? CFArrayGetCount(rlm-&gt;_timers) : 0; idx &lt; cnt; idx++) {
        CFRunLoopTimerRef rlt = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(rlm-&gt;_timers, idx);
        if (__CFIsValid(rlt) &amp;&amp; !__CFRunLoopTimerIsFiring(rlt)) {
            if (rlt-&gt;_fireTSR &lt;= limitTSR) {
                // ç­›é€‰ _fireTSR æ—©äºå½“å‰æ—¶åˆ»çš„ timers
                if (!timers) timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeArrayCallBacks);
                CFArrayAppendValue(timers, rlt);
            }
        }
    }
    for (CFIndex idx = 0, cnt = timers ? CFArrayGetCount(timers) : 0; idx &lt; cnt; idx++) {
        CFRunLoopTimerRef rlt = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(timers, idx);
        // ç­›é€‰åçš„ timer ä¾æ¬¡è°ƒç”¨ __CFRunLoopDoTimer
        Boolean did = __CFRunLoopDoTimer(rl, rlm, rlt);
        timerHandled = timerHandled || did;
    }
    if (timers) CFRelease(timers);
    return timerHandled;
}
</code></pre></div><p>æ¥ä¸‹æ¥ timers ä¾æ¬¡è°ƒç”¨ __CFRunLoopDoTimerï¼Œè¿™ä¸ªæ–¹æ³•ä¸­ä¼šè°ƒç”¨ timer çš„ä»»åŠ¡ rlt-&gt;_calloutï¼Œé‡æ–°æ’åº timerï¼Œæ³¨å†Œä¸‹ä¸€ä¸ª timerPortã€‚</p> <h2 id="ç»“è®º"><a href="#ç»“è®º" class="header-anchor">#</a> ç»“è®º</h2> <p>ä»æ·»åŠ  Timer åˆ°è§¦å‘ Timerï¼Œåˆ†æäº† Runloop Mode çš„æ•°æ®ç»“æ„ï¼Œè‡ªå§‹è‡³ç»ˆ CFRunLoopTimer éƒ½åœ¨è¢« Runloop ç®¡ç†ã€‚NSTimer å¯¹è±¡ä»…æ˜¯ Foundation åˆ° CoreFoundation è¡”æ¥çš„å¯¹è±¡ï¼Œé€šè¿‡ NSTimer å¯ä»¥åŒ¹é…æ“ä½œåˆ° CFRunLoopTimerRef å¯¹è±¡ï¼Œè€Œ CoreFoundation çš„å¯¹è±¡å·²ç»ç”±åº•å±‚ CFRetain å’Œ CFRelease æ–¹æ³•æ­£ç¡® Retain å’Œ Releaseã€‚ä¸å­˜åœ¨å¾ªç¯å¼•ç”¨ã€‚</p> <h1 id="end"><a href="#end" class="header-anchor">#</a> END</h1></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/my-blog/handbook/iOS/2024/202401/20240108.html#nstimer-ä¸-runloop" class="sidebar-link reco-side-nstimer-ä¸-runloop" data-v-cb1513f6>NSTimer ä¸ Runloop</a></li><li class="level-3" data-v-cb1513f6><a href="/my-blog/handbook/iOS/2024/202401/20240108.html#runloop-çš„-mode" class="sidebar-link reco-side-runloop-çš„-mode" data-v-cb1513f6>RunLoop çš„ Mode</a></li><li class="level-3" data-v-cb1513f6><a href="/my-blog/handbook/iOS/2024/202401/20240108.html#ä»æ·»åŠ -timer-å¼€å§‹" class="sidebar-link reco-side-ä»æ·»åŠ -timer-å¼€å§‹" data-v-cb1513f6>ä»æ·»åŠ  Timer å¼€å§‹</a></li><li class="level-3" data-v-cb1513f6><a href="/my-blog/handbook/iOS/2024/202401/20240108.html#è§¦å‘-timercallback" class="sidebar-link reco-side-è§¦å‘-timercallback" data-v-cb1513f6>è§¦å‘ TimerCallBack</a></li><li class="level-2" data-v-cb1513f6><a href="/my-blog/handbook/iOS/2024/202401/20240108.html#ç»“è®º" class="sidebar-link reco-side-ç»“è®º" data-v-cb1513f6>ç»“è®º</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><!----><!----><canvas id="vuepress-canvas-cursor"></canvas><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/my-blog/assets/js/app.83219bff.js" defer></script><script src="/my-blog/assets/js/3.e68ab5ce.js" defer></script><script src="/my-blog/assets/js/1.768e4641.js" defer></script><script src="/my-blog/assets/js/22.9bbde15a.js" defer></script>
  </body>
</html>
