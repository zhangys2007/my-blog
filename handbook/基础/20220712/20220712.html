<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Copy的本质 | 张茨一飞</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/my-blog/avatar.png">
    <meta name="description" content="老夫聊发少年狂,左牵黄,右擎苍,锦帽貂裘,千骑卷平冈。为报倾城随太守,亲射虎,看孙郎。 酒酣胸胆尚开张。鬓微霜,又何妨!持节云中,何日遣冯唐?会挽雕弓如满月,西北望,射天狼。">
    
    <link rel="preload" href="/my-blog/assets/css/0.styles.2175243c.css" as="style"><link rel="preload" href="/my-blog/assets/js/app.83219bff.js" as="script"><link rel="preload" href="/my-blog/assets/js/3.e68ab5ce.js" as="script"><link rel="preload" href="/my-blog/assets/js/1.768e4641.js" as="script"><link rel="preload" href="/my-blog/assets/js/34.5e3b35db.js" as="script"><link rel="prefetch" href="/my-blog/assets/js/10.c206caee.js"><link rel="prefetch" href="/my-blog/assets/js/11.9f4ed03b.js"><link rel="prefetch" href="/my-blog/assets/js/12.9c1daaff.js"><link rel="prefetch" href="/my-blog/assets/js/13.508ca0aa.js"><link rel="prefetch" href="/my-blog/assets/js/14.f2709fef.js"><link rel="prefetch" href="/my-blog/assets/js/15.fe2625e7.js"><link rel="prefetch" href="/my-blog/assets/js/16.14234636.js"><link rel="prefetch" href="/my-blog/assets/js/17.dac017be.js"><link rel="prefetch" href="/my-blog/assets/js/18.412e2895.js"><link rel="prefetch" href="/my-blog/assets/js/19.2fdd618b.js"><link rel="prefetch" href="/my-blog/assets/js/20.c12b7107.js"><link rel="prefetch" href="/my-blog/assets/js/21.9f012cff.js"><link rel="prefetch" href="/my-blog/assets/js/22.9bbde15a.js"><link rel="prefetch" href="/my-blog/assets/js/23.fae03859.js"><link rel="prefetch" href="/my-blog/assets/js/24.9c2773c9.js"><link rel="prefetch" href="/my-blog/assets/js/25.d72b23bf.js"><link rel="prefetch" href="/my-blog/assets/js/26.02e61b2e.js"><link rel="prefetch" href="/my-blog/assets/js/27.85eafcc1.js"><link rel="prefetch" href="/my-blog/assets/js/28.364da631.js"><link rel="prefetch" href="/my-blog/assets/js/29.b0ad14d8.js"><link rel="prefetch" href="/my-blog/assets/js/30.333ca256.js"><link rel="prefetch" href="/my-blog/assets/js/31.206c8a40.js"><link rel="prefetch" href="/my-blog/assets/js/32.7fb99002.js"><link rel="prefetch" href="/my-blog/assets/js/33.069f064a.js"><link rel="prefetch" href="/my-blog/assets/js/35.0bd3d6ff.js"><link rel="prefetch" href="/my-blog/assets/js/36.fda2e78e.js"><link rel="prefetch" href="/my-blog/assets/js/37.6f1fb53e.js"><link rel="prefetch" href="/my-blog/assets/js/4.b2fd2bed.js"><link rel="prefetch" href="/my-blog/assets/js/5.9d45f87e.js"><link rel="prefetch" href="/my-blog/assets/js/6.76b9de72.js"><link rel="prefetch" href="/my-blog/assets/js/7.0366ddcd.js"><link rel="prefetch" href="/my-blog/assets/js/8.df7f4290.js"><link rel="prefetch" href="/my-blog/assets/js/9.a3521382.js">
    <link rel="stylesheet" href="/my-blog/assets/css/0.styles.2175243c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>张茨一飞</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>老夫聊发少年狂,左牵黄,右擎苍,锦帽貂裘,千骑卷平冈。为报倾城随太守,亲射虎,看孙郎。 酒酣胸胆尚开张。鬓微霜,又何妨!持节云中,何日遣冯唐?会挽雕弓如满月,西北望,射天狼。</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>张茨一飞</span>
            
          <span data-v-25ba6db2>2015 - </span>
          2024
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/my-blog/" class="home-link router-link-active"><img src="/my-blog/avatar.png" alt="张茨一飞" class="logo"> <span class="site-name">张茨一飞</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <!----> <nav class="nav-links can-hide"><div class="nav-item"><a href="/my-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/categories/iOS开发/" class="nav-link"><i class="undefined"></i>
  iOS开发
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/面试题/" class="nav-link"><i class="undefined"></i>
  面试题
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/my-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      简历
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/views/Resume/resume.html" class="nav-link"><i class="undefined"></i>
  我的简历
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      友情链接
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><img src="avatar.png" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    张茨一飞
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>27</h3> <h6 data-v-39576ba9>文章</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>9</h3> <h6 data-v-39576ba9>标签</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/my-blog/" class="nav-link"><i class="iconfont reco-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/categories/iOS开发/" class="nav-link"><i class="undefined"></i>
  iOS开发
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/生活/" class="nav-link"><i class="undefined"></i>
  生活
</a></li><li class="dropdown-item"><!----> <a href="/my-blog/categories/面试题/" class="nav-link"><i class="undefined"></i>
  面试题
</a></li></ul></div></div><div class="nav-item"><a href="/my-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/my-blog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      简历
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/my-blog/views/Resume/resume.html" class="nav-link"><i class="undefined"></i>
  我的简历
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      友情链接
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zhangys2007" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Copy的本质</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>张茨一飞</span>
            
          <span data-v-25ba6db2>2015 - </span>
          2024
        </a></span></div></div> <div data-v-130b300a><main class="page" style="padding-right:0;"><section><div class="page-title"><h1 class="title">Copy的本质</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>张茨一飞</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>2022/7/12</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>Copy</span></i></div></div> <div class="theme-reco-content content__default"><h1 id="基本概念"><a href="#基本概念" class="header-anchor">#</a> 基本概念</h1> <p>就 iOS 开发而言，关于 copy 的几个概念：</p> <ol><li>拷贝：即复制，目的是产生副本，让原对象和副本相互独立，互不影响；</li> <li>不可变拷贝：即 copy 方法，无论原对象是否可变，都产生不可变副本；</li> <li>可变拷贝：即 mutableCopy 方法，无论原对象是否可变，都产生可变副本；</li> <li>深拷贝：内容拷贝，产生新的对象；</li> <li>浅拷贝：指针拷贝，不产生新的对象；</li></ol> <p>由上可知，copy 和深拷贝是两个概念，两者并不一定相等，先给结果：</p> <ul><li>源对象不可变时，copy 方法就是浅拷贝；</li> <li>源对象可变时，copy 方法就是深拷贝；</li> <li>mutableCopy 方法无论何种情况都是深拷贝；</li></ul> <h1 id="copy-修饰属性"><a href="#copy-修饰属性" class="header-anchor">#</a> copy 修饰属性</h1> <p>上文中知道了，拷贝分深拷贝和浅拷贝，那么@property中的copy关键字是干嘛的呢？有没有 mutablecopy 关键字呢？
先说结论：</p> <ul><li>属性中 copy 关键字的作用就是调用被赋值给属性的对象的copyWithZone方法，并将返回值赋值给属性;</li></ul> <p>再来看源码, 首先看一段我们常用的属性声明代码：</p> <div class="language- extra-class"><pre><code>@interface XKPerson()
@property (copy, nonatomic) NSString *name;
@property (assign, nonatomic) NSInteger age;

@end

@implementation XKPerson

@end
</code></pre></div><p>使用编译指令生成 cpp 文件：</p> <div class="language- extra-class"><pre><code>xcrun  -sdk  iphoneos  clang  -arch  arm64  -rewrite-objc XKPerson.m -o XKPerson.cpp
</code></pre></div><p>然后我们来找找property最后生成的代码是怎样的，cpp 文件中关于属性的实现代码如图所示：</p> <div class="language- extra-class"><pre><code>// @interface XKPerson()
// @property (copy, nonatomic) NSString *name;
// @property (assign, nonatomic) NSInteger age;
/* @end */

// @implementation XKPerson

static NSString * _I_XKPerson_name(XKPerson * self, SEL _cmd) { return (*(NSString **)((char *)self + OBJC_IVAR_$_XKPerson$_name)); }
extern &quot;C&quot; __declspec(dllimport) void objc_setProperty (id, SEL, long, id, bool, bool);

static void _I_XKPerson_setName_(XKPerson * self, SEL _cmd, NSString *name) { objc_setProperty (self, _cmd, __OFFSETOFIVAR__(struct XKPerson, _name), (id)name, 0, 1); }

static NSInteger _I_XKPerson_age(XKPerson * self, SEL _cmd) { return (*(NSInteger *)((char *)self + OBJC_IVAR_$_XKPerson$_age)); }
static void _I_XKPerson_setAge_(XKPerson * self, SEL _cmd, NSInteger age) { (*(NSInteger *)((char *)self + OBJC_IVAR_$_XKPerson$_age)) = age; }
// @end
</code></pre></div><p>也就是说，@property只是告诉编译器，帮我生成 setter和 getter方法，也就是声明并实现了四个方法：</p> <div class="language- extra-class"><pre><code>    static NSString * _I_XKPerson_name
    static void I_XKPerson_setName
    static NSInteger _I_XKPerson_age
    static void I_XKPerson_setAge
</code></pre></div><p>这里，因为我们在探究属性中的 copy，而且 copy 只在设置属性的时候起作用，所以我们只需要关注 <em>I_XKPerson_setName</em> 这个方法即可，其核心是调用了objc_setProperty()这个函数，那么我们来到 objc4 的源码，下载 源码后看看objc_setProperty这个函数做了啥，代码如下：</p> <div class="language- extra-class"><pre><code>    #define MUTABLE_COPY 2
    void objc_setProperty(id self, SEL _cmd, ptrdiff_t offset, id newValue, BOOL atomic, signed char shouldCopy) 
    {
        bool copy = (shouldCopy &amp;&amp; shouldCopy != MUTABLE_COPY);
        bool mutableCopy = (shouldCopy == MUTABLE_COPY);
        // copy 和 mutableCopy最多只有一个为真(1)
        reallySetProperty(self, _cmd, newValue, offset, atomic, copy, mutableCopy);
    }
</code></pre></div><p>其余代码就不贴了，MUTABLE_COPY值为2，而setter中传的值为1，最终会进入到reallySetProperty这个方法：</p> <div class="language- extra-class"><pre><code>    static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy){
    if (offset == 0) {
        // 修改 isa 指向
        object_setClass(self, newValue);
        return;
    }
    id oldValue;
    id *slot = (id*) ((char*)self + offset);
    // copy的逻辑
    if (copy) {
        // 属性修饰关键字只有 copy
        newValue = [newValue copyWithZone:nil];
    } else if (mutableCopy) {
        // 属性修饰关键字只有 copy , 这里是实现了 mutableCopying 协议时的处理逻辑
        newValue = [newValue mutableCopyWithZone:nil];
    } else {
        if (*slot == newValue) return;
        newValue = objc_retain(newValue);
    }
    if (!atomic) {
        oldValue = *slot;
        *slot = newValue;
    } else {
        spinlock_t&amp; slotlock = PropertyLocks[slot];
        slotlock.lock();
        oldValue = *slot;
        *slot = newValue;        
        slotlock.unlock();
    }
    // 释放原对象
    objc_release(oldValue);
    }
</code></pre></div><p>其实这段代码还是挺经典的，但是我们只看 copy 的部分：</p> <div class="language- extra-class"><pre><code>    // copy的逻辑
    if (copy) {
        // 属性修饰关键字只有 copy ，所以最终会进入到这里
        newValue = [newValue copyWithZone:nil];
    } else if (mutableCopy) {
        // 属性修饰关键字只有 copy , 这里是实现了 mutableCopying 协议时的处理逻辑
        newValue = [newValue mutableCopyWithZone:nil];
    } else {
        if (*slot == newValue) return;

        // NSString等不可变对象调用copy，其内部的代码逻辑会走到这里来
        // 此时 copy 不产生新的对象，属于浅拷贝，所以 copy 和 retain 的代码逻辑等价(但是可不能将 copy 关键字替换成 retain 哦😯~)
        newValue = objc_retain(newValue);
    }
</code></pre></div><p>从源码中就一目了然了：</p> <ol><li>如果是 copy 方法，则调用对象的 copyWithZone方法；</li> <li>如果是mutablecopy，则调用对象的mutableCopyWithZone 方法；</li> <li>如果 copy = 0，mutablecopy = 0，那么最终会调用objc_retain方法；</li></ol> <p>其中，使用retain修饰属性时，就是第三种情况，代码中也可以得到验证，修改copy为 retain后编译的结果：</p> <div class="language- extra-class"><pre><code>    // 最后一个参数由 1 变成了 0
    static void _I_XKPerson_setName_(XKPerson * self, SEL _cmd, NSString *name) {   
        objc_setProperty (self, _cmd, __OFFSETOFIVAR__(struct XKPerson, _name), (id)name, 0, 0); 
    }
</code></pre></div><p>另外，如果使用 strong 和 assign修饰，最终 setter 不调用 objc_setProperty方法而是通过偏移量进行指针赋值或者直接赋值，具体就不再这里探讨了~~</p> <hr> <p>这里留个疑问：</p> <p>如果用 copy 修饰，那么属性最终转化成的 setter 中执行的 objc_setProperty 方法的传值中，最后一个参数永远为1。而objc_setProperty内部调用的也是reallySetProperty方法。为1时，调用reallySetProperty方法中的参数永远是bool copy = 1, bool mutablecopy = 0，也就是会走到copyWithZone这层逻辑。而使用 retain修饰属性，参数bool copy = 0, bool mutablecopy = 0，会走到obje_retain这层逻辑，归纳如下：</p> <table><thead><tr><th>关键字</th> <th>参数copy的值</th> <th>参数mutablecopy的值</th> <th>代码逻辑</th></tr></thead> <tbody><tr><td>retain</td> <td>0</td> <td>0</td> <td>obje_retain()</td></tr> <tr><td>copy</td> <td>1</td> <td>0</td> <td>copyWithZone()</td></tr></tbody></table> <p>只有objc_setProperty最后一个参数为 2 时，才会走到 mutableCopy 的逻辑，所以reallySetProperty方法中的mutablecopyWithZone的代码何时会被调用呢？？？</p> <h1 id="使用-copy-修饰字符串意义"><a href="#使用-copy-修饰字符串意义" class="header-anchor">#</a> 使用 copy 修饰字符串意义</h1> <p>先说结论，使用 copy 修饰属性的意义在于：</p> <p>明确告诉使用者，设计者不希望且不能直接修改属性对象所指向的内存地址的值；</p> <p>不希望体现在使用使用 NSString 类型来声明属性，这样如果使用 appendString:的方法，就报报编译错误。
但是，如果使用 strong 来修饰字符串属性，加上强制类型转换，仍然可以实现直接修改内存地址中的值：</p> <div class="language- extra-class"><pre><code>    // person对象中使用 strong 修饰 属性
    @property (strong, nonatomic) NSString *name1;
    XKPerson *p = [XKPerson new];   
    NSMutableString *name = [[NSMutableString alloc] initWithFormat:@&quot;%@&quot;,@&quot;Jack&quot;];
    // 此时如果是用 strong 修饰 name，虽然声明的是 NSString 对象，但实际类型是 NSMutableString 类型
    p.name = name;
    [(NSMutableString *)p.name appendFormat:@&quot;1&quot;];
</code></pre></div><p>以上代码就实现了直接修改属性所指向的内存地址中的值，此时修改成使用 copy 修饰，因为调用的copyWithZone，结果返回的必定是不可变类型，所以即使赋值时是NSMutableString类型，最终得到的仍然是NSString类型，这样就起到了预期的效果；
所以，NSString 类型使用 copy 修饰是最好不过的~~~</p> <p>这里还涉及到一个场景，比如我们开发中，希望字符串属性跟随某个字符串对象的值同时改变，这个时候就要使用 strong + NSMutableString了：</p> <div class="language- extra-class"><pre><code>    @property (strong, nonatomic) NSMutableString *name;
    // 使用
    XKPerson *p = [XKPerson new];
    NSMutableString *name = [NSMutableString stringWithFormat:@&quot;王&quot;];
    p.name = name;
    NSLog(@&quot;%@&quot;,p.name);
    [name appendString:@&quot;小二&quot;];
    NSLog(@&quot;%@&quot;,p.name);
</code></pre></div><p>结果：</p> <div class="language- extra-class"><pre><code>    2019-12-27 17:53:51.730 XKStringTest[10172:63201310] 王
    2019-12-27 17:53:51.731 XKStringTest[10172:63201310] 王小二
</code></pre></div><p>这个时候如果使用 copy 修饰，再使用[self.name appendString：@&quot;xxx&quot;] 反而会崩溃，和使用 copy 修饰 NSMutableArray 时同理。
再重申一遍：copy 是为了获得不可变副本，mutableCopy 是为了获取可变副本，而修饰属性的关键字只有 copy。
这个场景中使用其实应该使用 mutableCopy 修饰，创建的就是可变的独立字符串副本了，但是 没有 mutableCopy 关键字修饰属性。
所以，切记哦😯：</p> <p>在属性中不要使用 copy 修饰NSMutableArray、NSMutableDictionary等可变类型；</p> <h1 id="copy-协议"><a href="#copy-协议" class="header-anchor">#</a> copy 协议</h1> <p>上一章节讲到了属性修饰中 copy 关键字的本质是调用copyWithZone方法。之所以能够使用 copy 修饰字符串、数组等，是因为这些系统对象实现了 copy 相关的协议。
所以，这里就涉及到一个问题：自定义copyWithZone方法。平常我们使用 copy 修饰的最多的就是字符串
因此，OC 中给我们提供了两个协议：</p> <div class="language- extra-class"><pre><code>    @protocol NSCopying
    - (id)copyWithZone:(nullable NSZone *)zone;
    @end

    @protocol NSMutableCopying
    - (id)mutableCopyWithZone:(nullable NSZone *)zone;
    @end
</code></pre></div><p>具体实现如下：</p> <div class="language- extra-class"><pre><code>    - (id)copyWithZone:(NSZone *)zone {
        XKPerson *newP = [[XKPerson allocWithZone:zone] init];
        newP.name = self.name;
        newP.age = self.age;
        return newP;
    }

    - (id)mutableCopyWithZone:(NSZone *)zone {
        XKPerson *newP = [[XKPerson allocWithZone:zone] init];
        newP.name = self.name;
        newP.age = 10;
        return newP;
    }
</code></pre></div><p>使用：</p> <div class="language- extra-class"><pre><code>    XKPerson *p = [XKPerson new];
    p.name = @&quot;Jack&quot;;
    p.age = 18;
    XKPerson *p1 = [p copy];
    XKPerson *p2 = [p mutableCopy];
    NSLog(@&quot;%p %p %p&quot;, p, p1, p2);
    p1.name = @&quot;Lucy&quot;;
    NSLog(@&quot;%@&quot;,p1.name);
</code></pre></div><p>结果：</p> <div class="language- extra-class"><pre><code>    2019-12-27 17:42:11.326 XKStringTest[9991:63192515] 0x7ae30b10 0x7ae31340 0x7ae313e0
    2019-12-27 17:42:11.327 XKStringTest[9991:63192515] Lucy
</code></pre></div><p>copy 在数据模型 model 中时可能会较多使用 copy，此时实现copy协议即可，但在平时自定义对象使用 copy 并不多，这两个协议就不多说了~~</p> <h1 id="block-为什么使用-copy-修饰"><a href="#block-为什么使用-copy-修饰" class="header-anchor">#</a> Block 为什么使用 copy 修饰</h1> <p>会在 block进阶中讲到，但是这里也把核心说一下，来看一段代码就能看到本质，非 ARC 模式下代码如下：</p> <div class="language- extra-class"><pre><code>    int main(int argc, const char * argv[]) {
        @autoreleasepool {
        // 看看 block 中 copy 方法的本质
        int age = 10;
        void(^block)(void) = ^(void){
            NSLog(@&quot;%d&quot;,age);
         };
    
        NSLog(@&quot;%p&quot;,block);
        NSLog(@&quot;%@&quot;,[block class]);
        block = [block copy];
        NSLog(@&quot;%p&quot;,block);
        NSLog(@&quot;%@&quot;,[block class]);

        }
        return 0;
    }
</code></pre></div><p>打印结果：</p> <div class="language- extra-class"><pre><code>    2020-01-03 09:02:36.888792+0800 XKBlockTest[84409:72373799] 0x7ffeefbff488
    2020-01-03 09:02:36.889375+0800 XKBlockTest[84409:72373799] __NSStackBlock__
    2020-01-03 09:02:36.889904+0800 XKBlockTest[84409:72373799] 0x1006444b0
    2020-01-03 09:02:36.889961+0800 XKBlockTest[84409:72373799] __NSMallocBlock__
</code></pre></div><p>分析：</p> <ol><li>代码中只是为了测试，所以省去了 release 等操作；</li> <li>copy 的本质和字符串等的实现大同小异，都是返回一个不可变对象；</li> <li>因为访问了 auto 变量的 Block 作为__NSStackBlock__存放在栈中，否则作为__NSGlobalBlock__存放在数据区(全局区)，栈中的 Block 随时会被销毁，所以系统实现的 copy 操作在堆中创建了一个全新的 Block 并返回，这就是两次打印内存结果不一样的原因；</li> <li>Block 存放在堆中时被标记成__NSMallocBlock__类型，非 ARC 中需要手动 release；</li> <li>Block 使用 copy 修饰时，同字符串等一样，会调用新值的 copy 方法，也就是 Block 的 copy 方法；</li> <li>Block 属性使用weak修饰不用多说，既不调用 copy 方法，也不增加引用计数器；</li></ol> <p>直接说总结吧：
因为 ARC 会在几种特定情况下主动调用 Block 的 copy 方法，比如被 strong 修饰时，GCD中的Block、系统的 UsingBlock 方法等，所以：</p> <ul><li>ARC 中的 Block 属性使用 copy 和 strong 修饰 Block 都可以</li></ul> <ol><li>使用 copy 修饰时，相当于主动调用 copy 方法，StackBlock 会被拷贝到堆上而成为 MallocBlock；</li> <li>使用 strong 修饰时，ARC 模式下，会自动调用 copy 方法，StackBlock 会被拷贝到堆上而成为 MallocBlock；</li></ol> <ul><li>MRC 中的 Block 属性必须使用 copy 修饰</li></ul> <ol><li>使用 copy 修饰时，相当于主动调用 copy 方法，StackBlock 会被拷贝到堆上而成为 MallocBlock；</li> <li>MRC 模式下，strong 修饰 Block 只会 retain，不会自动调用 Block 的 copy 方法；</li></ol> <h1 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h1> <p>以上，总结下 copy 的几个重点，方便记忆：</p> <ol><li>copy 的目的是创建一个互不干扰，相互独立的副本；</li> <li>copy 无论是直接调用还是修饰属性，其本质是调用copyWithZone和mutableCopyWithZone方法；</li> <li>深浅复制的区别在于返回值是否为新创建的对象，和调用 copy 的哪个方法无关；</li> <li>使用 copy 修饰属性的关键目的是告诉使用者，这个不要直接修改属性所指向内存中的值；</li> <li>修饰可变类型的对象，比如可变数组，严禁使用 copy 修饰；</li> <li>copy 的本质是调用 copy 协议中的两个方法，只是系统对字符串、数组、字典、NSNumber 和 Block 实现了该协议的两个方法，其中两个方法所实现的逻辑大同小异；</li> <li>copy 修饰属性的本质是自动调用新值的 copy 方法以获取一个不可变对象，属性无 mutableCopy 修饰，因为没有必要；</li> <li>copy 修饰 Block 属性的本质仍然是调用 copy 方法，只是其内部实现是将存放在栈上的 block 转移到堆上，否则栈中的 Block 被销毁后会访问指向该 Block 的指针会产生坏内存访问问题；</li></ol></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:0;" data-v-cb1513f6></ul></main> <!----></div></div></div></div><div class="global-ui"><!----><!----><canvas id="vuepress-canvas-cursor"></canvas><!----><div class="RibbonAnimation"></div></div></div>
    <script src="/my-blog/assets/js/app.83219bff.js" defer></script><script src="/my-blog/assets/js/3.e68ab5ce.js" defer></script><script src="/my-blog/assets/js/1.768e4641.js" defer></script><script src="/my-blog/assets/js/34.5e3b35db.js" defer></script>
  </body>
</html>
